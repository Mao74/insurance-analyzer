<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Tecnica e Revisione Polizza</title>
    <!-- Chart.js per grafici sinistri -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet.js per Mappa Geografica -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-body: #f4f6f8;
            --bg-paper: #ffffff;
            --primary-dark: #0f172a;
            --primary-main: #334155;
            --accent-gold: #b49b66;
            --accent-blue: #2563eb;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-subtle: #e2e8f0;
            --border-strong: #cbd5e1;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 30px;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-size: 13px;
        }

        .report-container {
            max-width: 1280px;
            margin: 0 auto;
            background-color: var(--bg-paper);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        /* --- HEADER --- */
        .header {
            padding: 30px 40px;
            background: white;
            border-bottom: 4px solid var(--primary-dark);
        }

        .header h1 {
            font-family: 'Merriweather', serif;
            font-size: 28px;
            margin: 0 0 5px 0;
            color: var(--primary-dark);
        }

        .header h2 {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 0 0 20px 0;
            font-weight: 700;
        }

        /* --- TABS --- */
        .tabs {
            background: var(--primary-dark);
            padding: 0 20px;
            display: flex;
            overflow-x: auto;
        }

        .tab-link {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            padding: 16px 24px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-link.active {
            color: white;
            border-bottom-color: var(--accent-gold);
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- CONTENT --- */
        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        h3 {
            color: var(--primary-main);
            border-bottom: 2px solid var(--border-subtle);
            padding-bottom: 10px;
            margin-top: 30px;
            font-family: 'Merriweather', serif;
            font-size: 18px;
        }

        h4 {
            color: var(--primary-dark);
            margin: 20px 0 10px 0;
            font-size: 14px;
        }

        /* --- TABELLE --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
        }

        th {
            background: #f1f5f9;
            color: var(--primary-dark);
            font-weight: 700;
            padding: 10px 12px;
            text-align: left;
            border: 1px solid var(--border-strong);
        }

        td {
            padding: 8px 12px;
            border: 1px solid var(--border-subtle);
            vertical-align: middle;
        }

        tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .col-curr {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
            color: var(--primary-dark);
        }

        .col-center {
            text-align: center;
        }

        /* --- MAPPA --- */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border-strong);
            margin-bottom: 30px;
            z-index: 1;
        }

        /* --- ANAGRAFICA GRID --- */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1px;
            background: var(--border-strong);
            border: 1px solid var(--border-strong);
            margin-bottom: 20px;
        }

        .info-item {
            background: white;
            padding: 12px 15px;
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 13px;
            font-weight: 500;
            color: var(--primary-dark);
        }

        /* --- MATRICE FRANCHIGIE --- */
        .deductible-matrix {
            border: 1px solid var(--border-strong);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--shadow-card);
        }

        .dm-header {
            background: var(--primary-main);
            color: white;
            padding: 10px 15px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            display: grid;
            grid-template-columns: 3fr 1.5fr 1fr 1fr 1.5fr;
        }

        .dm-row {
            display: grid;
            grid-template-columns: 3fr 1.5fr 1fr 1fr 1.5fr;
            border-bottom: 1px solid var(--border-subtle);
            align-items: center;
            background: white;
        }

        .dm-row:last-child {
            border-bottom: none;
        }

        .dm-cell {
            padding: 10px 15px;
            font-size: 12px;
        }

        .dm-label {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .dm-sub {
            font-size: 11px;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
            font-style: italic;
        }

        .dm-val {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }

        /* --- LOCATION CARD (GRANULAR) --- */
        .location-block {
            border: 1px solid var(--border-strong);
            border-radius: 6px;
            margin-bottom: 30px;
            background: white;
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .loc-header {
            background: #f1f5f9;
            color: var(--primary-dark);
            padding: 12px 20px;
            font-weight: 700;
            border-bottom: 1px solid var(--border-strong);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loc-body {
            padding: 0;
        }

        .loc-activity {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border-subtle);
            font-style: italic;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* --- CAT NAT GRID --- */
        .catnat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .risk-card {
            border: 1px solid var(--border-strong);
            border-radius: 6px;
            background: white;
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .risk-header {
            background: var(--primary-main);
            color: white;
            padding: 10px;
            font-size: 12px;
            font-weight: 700;
            text-align: center;
        }

        .risk-body {
            padding: 15px;
            display: grid;
            gap: 15px;
        }

        .risk-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 8px;
        }

        .risk-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .risk-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .risk-low {
            background: #dcfce7;
            color: #166534;
        }

        .risk-med {
            background: #fef9c3;
            color: #854d0e;
        }

        .risk-high {
            background: #fee2e2;
            color: #991b1b;
        }

        /* --- CLAUSE CARDS --- */
        .clause-card {
            border: 1px solid var(--border-strong);
            border-radius: 6px;
            background: white;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
        }

        .clause-header {
            background: #f8fafc;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            justify-content: space-between;
        }

        .clause-body {
            padding: 15px 20px;
        }

        .clause-alert {
            margin-top: 10px;
            padding: 10px;
            background: #fff1f2;
            border: 1px solid #fecdd3;
            border-radius: 4px;
            color: #9f1239;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            gap: 10px;
        }

        .clause-vincolo {
            margin-top: 10px;
            padding: 10px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 4px;
            color: #1e40af;
            font-size: 12px;
        }

        /* --- PRINT --- */
        @media print {
            body {
                padding: 0;
                background: white;
            }

            .report-container {
                border: none;
                box-shadow: none;
                width: 100%;
            }

            .tabs,
            .print-btn {
                display: none;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .location-block,
            .risk-card,
            .deductible-matrix,
            .clause-card {
                page-break-inside: avoid;
                border: 1px solid #ccc;
                box-shadow: none;
            }

            .catnat-grid {
                display: block;
            }

            .risk-card {
                margin-bottom: 15px;
                page-break-inside: avoid;
            }

            th {
                background-color: #eee !important;
                -webkit-print-color-adjust: exact;
            }

            .risk-tag {
                border: 1px solid #ccc;
            }

            .chart-container,
            #map {
                height: 250px;
                page-break-inside: avoid;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>

<body>

    <div class="report-container">
        <div class="header">
            <h1>Analisi Tecnica e Revisione Polizza</h1>
            <h2>Property All Risks & Business Interruption</h2>
            <p style="font-size:12px; color:#64748b; margin:5px 0 0 0;">Rif. Polizza: <strong
                    style="color:#0f172a;">[NUMERO_POLIZZA]</strong></p>
        </div>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'Sintesi')">1. Sintesi Anagrafica</button>
            <button class="tab-link" onclick="openTab(event, 'Beni')">2. Beni & Mappa</button>
            <button class="tab-link" onclick="openTab(event, 'CatNat')">3. Analisi Cat-Nat</button>
            <button class="tab-link" onclick="openTab(event, 'Garanzie')">4. Garanzie</button>
            <button class="tab-link" onclick="openTab(event, 'Sinistri')">5. Sinistri</button>
            <button class="tab-link" onclick="openTab(event, 'Appendici')">6. Audit Trail</button>
            <button class="tab-link" onclick="openTab(event, 'Clausole')">7. Clausole e Vincoli</button>
        </div>

        <!-- 1. SINTESI -->
        <div id="Sintesi" class="tab-content active">
            <button class="print-btn"
                style="float:right; background:var(--primary-main); color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;"
                onclick="window.print()">Stampa Report</button>
            <h3>Dati Generali e Contrattuali</h3>

            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Contraente</span>
                    <span class="info-value">[CONTRAENTE]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Sede Legale</span>
                    <span class="info-value">[SEDE_LEGALE]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Partita IVA</span>
                    <span class="info-value">[PIVA]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Compagnia / Delegataria</span>
                    <span class="info-value">[COMPAGNIA]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Broker / Intermediario</span>
                    <span class="info-value">[BROKER]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Decorrenza / Scadenza</span>
                    <span class="info-value">[DECORRENZA] - [SCADENZA]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Frazionamento Premio</span>
                    <span class="info-value">[FRAZIONAMENTO]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Termini di Disdetta</span>
                    <span class="info-value">[DISDETTA]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Mora (Grace Period)</span>
                    <span class="info-value">[MORA]</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Premio Annuo Lordo</span>
                    <span class="info-value" style="color:var(--accent-blue); font-weight:700;">[PREMIO_TOTALE]</span>
                </div>
            </div>
        </div>

        <!-- 2. BENI & MAPPA -->
        <div id="Beni" class="tab-content">
            <h3>Mappa Concentrazione Rischi</h3>
            <div id="map"></div>

            <h3>Dettaglio Analitico Ubicazioni e Valori</h3>
            <p class="note" style="font-style:italic; color:gray; margin-bottom:20px;">Analisi disaggregata per Societ√†
                Assicurata e Partita di Polizza.</p>

            <!-- AI LOOP: Generare un blocco .location-block per OGNI societ√†/sede trovata -->
            <div class="location-block">
                <div class="loc-header">
                    <span>Societ√†: [NOME_SOCIETA] - Sede: [CITTA]</span>
                    <span>Totale Assicurato: [TOT_SA_SEDE]</span>
                </div>
                <div class="loc-body">
                    <div class="loc-activity">
                        <strong>Attivit√† Dichiarata:</strong> [ATTIVITA]
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width:30%">Partita</th>
                                <th class="col-curr" style="width:25%">Somma Assicurata (‚Ç¨)</th>
                                <th class="col-center" style="width:15%">Tasso (‚Ä∞)</th>
                                <th class="col-curr" style="width:20%">Premio Imponibile (‚Ç¨)</th>
                                <th style="width:10%">Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- AI LOOP: Una riga per ogni partita (NO accorpamenti) -->
                            <tr>
                                <td>Fabbricati</td>
                                <td class="col-curr">...</td>
                                <td class="col-center">...</td>
                                <td class="col-curr">...</td>
                                <td>Valore a Nuovo</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- END LOOP -->
        </div>

        <!-- 3. CAT NAT -->
        <div id="CatNat" class="tab-content">
            <h3>Risk Engineering: Esposizione Catastrofale</h3>
            <p>Analisi puntuale di tutte le ubicazioni censite in polizza.</p>

            <div
                style="background:#eff6ff; border:1px solid #bfdbfe; border-radius:6px; padding:15px; margin-bottom:25px; font-size:11px;">
                <strong style="color:#1e40af;">üìä FONTI CLASSIFICAZIONE:</strong><br>
                <span style="color:#334155;">
                    ‚Ä¢ <strong>Zona Sismica:</strong> Classificazione sismica nazionale (INGV/Protezione Civile) -
                    aggiornamento 2023<br>
                    ‚Ä¢ <strong>Rischio Idrogeologico:</strong> Database ISPRA - Dissesto Idrogeologico e mappe PAI
                    regionali<br>
                    ‚Ä¢ <strong>Rischio Frane:</strong> ISPRA - Inventario Fenomeni Franosi (IFFI) e aree PAI<br>
                    ‚Ä¢ <strong>Rischio Prossimit√†:</strong> Analisi georeferenziata (industrie RIR, infrastrutture
                    critiche, aeroporti)
                </span>
            </div>

            <div class="catnat-grid">
                <!-- AI LOOP: Una card per OGNI indirizzo distinto -->
                <div class="risk-card">
                    <div class="risk-header">[INDIRIZZO_COMPLETO]</div>
                    <div class="risk-body">
                        <div class="risk-row">
                            <span style="font-size:11px; color:gray;">Zona Sismica</span>
                            <span class="risk-tag [CLASS_SISMICA]">[ZONA_SISMICA]</span>
                        </div>
                        <div class="risk-row">
                            <span style="font-size:11px; color:gray;">Rischio Idro</span>
                            <span class="risk-tag [CLASS_IDRO]">[RISCHIO_IDRO]</span>
                        </div>
                        <div class="risk-row">
                            <span style="font-size:11px; color:gray;">Rischio Frane</span>
                            <span class="risk-tag [CLASS_FRANE]">[RISCHIO_FRANE]</span>
                        </div>
                        <div class="risk-row">
                            <span style="font-size:11px; color:gray;">Rischio Prossimit√†</span>
                            <span class="risk-tag [CLASS_PROSSIMITA]">[RISCHIO_PROSSIMITA]</span>
                        </div>
                        <div style="font-size:11px; margin-top:10px; border-top:1px solid #eee; padding-top:8px;">
                            <strong>Note Tecniche:</strong> [NOTE_GEO]
                        </div>
                    </div>
                </div>
                <!-- END LOOP -->
            </div>
        </div>

        <!-- 4. GARANZIE -->
        <div id="Garanzie" class="tab-content">
            <h3>Matrice Completa Garanzie e Franchigie</h3>
            <p>Inventario esaustivo di tutte le coperture previste in polizza.</p>

            <div class="deductible-matrix">
                <div class="dm-header">
                    <span>Garanzia / Evento</span>
                    <span style="text-align:right">Massimale / Sottolimite</span>
                    <span style="text-align:right">Franchigia Fissa</span>
                    <span style="text-align:right">Scoperto %</span>
                    <span style="text-align:right">Min / Max Scoperto</span>
                </div>

                <!-- AI INSTRUCTION: Inserire TUTTE le garanzie qui -->
                <div class="dm-row">
                    <div class="dm-cell dm-label">Incendio (Base)</div>
                    <div class="dm-cell dm-val">...</div>
                    <div class="dm-cell dm-val">...</div>
                    <div class="dm-cell dm-val">...</div>
                    <div class="dm-cell dm-val">...</div>
                </div>
            </div>
        </div>

        <!-- 5. SINISTRI -->
        <div id="Sinistri" class="tab-content">
            <h3>Andamento Tecnico (S/P Ratio)</h3>

            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <div
                    style="flex:1; background:white; padding:15px; border:1px solid var(--border-strong); border-radius:6px;">
                    <div style="font-size:10px; text-transform:uppercase; color:gray;">Loss Ratio (S/P)</div>
                    <div style="font-size:22px; font-weight:700;" id="kpiRatio">...</div>
                </div>
                <div
                    style="flex:1; background:white; padding:15px; border:1px solid var(--border-strong); border-radius:6px;">
                    <div style="font-size:10px; text-transform:uppercase; color:gray;">Totale Sinistri (Pag+Ris)</div>
                    <div style="font-size:22px; font-weight:700; color:#b91c1c;" id="kpiClaims">...</div>
                </div>
            </div>

            <div
                style="height:350px; background:white; padding:20px; border:1px solid var(--border-strong); border-radius:8px; margin-bottom:30px;">
                <canvas id="claimsChart"></canvas>
            </div>

            <h3>Registro Analitico</h3>
            <table>
                <thead>
                    <tr>
                        <th>N. Sinistro</th>
                        <th>Data Evento</th>
                        <th>Ubicazione</th>
                        <th>Causa</th>
                        <th>Stato</th>
                        <th class="col-curr">Importo (‚Ç¨)</th>
                    </tr>
                </thead>
                <tbody id="claimsTableBody">
                    <!-- AI Populates Rows -->
                </tbody>
            </table>
        </div>

        <!-- 6. AUDIT TRAIL (APPENDICI) - NUOVO -->
        <div id="Appendici" class="tab-content">
            <h3>Cronologia Modifiche Contrattuali</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width:15%">N. Appendice</th>
                        <th style="width:15%">Data Effetto</th>
                        <th style="width:40%">Oggetto della Variazione</th>
                        <th style="width:30%">Impatto / Note</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- AI Populates Appendices -->
                    <tr>
                        <td>...</td>
                        <td>...</td>
                        <td>...</td>
                        <td>...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 7. CLAUSOLE E VINCOLI -->
        <div id="Clausole" class="tab-content">
            <h3>Vincoli e Appendici di Vincolo</h3>
            <div id="vincoliContainer">
                <!-- AI LOOP per Vincoli -->
                <div class="clause-vincolo">
                    <strong>Beneficiario:</strong> [BENEFICIARIO] <br>
                    <strong>Oggetto:</strong> [OGGETTO_VINCOLO] <br>
                    <strong>Riferimento:</strong> [RIF_APPENDICE]
                </div>
            </div>

            <h3 style="margin-top:40px;">Schede Tecniche Garanzie Complesse</h3>
            <div class="clause-card">
                <div class="clause-header">Eventi Atmosferici</div>
                <div class="clause-body">
                    <p>...</p>
                    <div class="clause-alert">
                        <strong>Criticit√†:</strong> Esclusione tipica per fabbricati aperti o tettoie non conformi.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, x, tablinks;
            x = document.getElementsByClassName("tab-content");
            for (i = 0; i < x.length; i++) { x[i].style.display = "none"; }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
            document.getElementById(tabName).style.display = "block";

            // Hack per forzare il redraw della mappa se √® il tab Beni
            if (tabName === 'Beni' && typeof map !== 'undefined') {
                setTimeout(function () { map.invalidateSize(); }, 100);
            }

            evt.currentTarget.className += " active";
        }

        /* [AI_CHART_DATA_START] */
        // Placeholder data needed by JS
        // const years = ['2023', '2024'];
        // const premiums = [100, 100];
        // const claims = [10, 20];
        /* [AI_CHART_DATA_END] */

        /* [AI_MAP_DATA_START] */
        // Placeholder data for Map
        // const locationsData = [
        //    { name: "Sede Milano", lat: 45.4642, lng: 9.1900, value: 1000000, desc: "Uffici" }
        // ];
        /* [AI_MAP_DATA_END] */


        // --- INIT MAP ---
        var map;
        if (typeof locationsData !== 'undefined' && document.getElementById('map')) {
            // Find location with highest insured value
            let maxLocation = locationsData[0];
            locationsData.forEach(loc => {
                if (loc.value > maxLocation.value) {
                    maxLocation = loc;
                }
            });

            // Init Map centered on location with highest value, zoom level 9 (adjustable)
            map = L.map('map').setView([maxLocation.lat, maxLocation.lng], 9);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Draw Bubbles
            var group = new L.featureGroup();
            locationsData.forEach(loc => {
                // Simple scaling logic: radius depends on value size relative to others
                // Just for visualization: Math.sqrt(value) / constant
                let radius = Math.sqrt(loc.value) / 20;
                if (radius < 1000) radius = 1000; // Min size visibility

                var circle = L.circle([loc.lat, loc.lng], {
                    color: '#ef4444',
                    fillColor: '#f87171',
                    fillOpacity: 0.5,
                    radius: radius
                }).addTo(map);

                // Format value to Euro
                let valFmt = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(loc.value);

                circle.bindPopup(`<b>${loc.name}</b><br>${loc.desc}<br>Totale Assicurato: <b>${valFmt}</b>`);
                group.addLayer(circle);
            });

            // Note: fitBounds() rimosso per mantenere il centro sulla location principale
        }

        // --- INIT CHART ---
        if (typeof years !== 'undefined' && document.getElementById('claimsChart')) {
            const ctx = document.getElementById('claimsChart').getContext('2d');

            const totClaims = claims.reduce((a, b) => a + b, 0);
            const totPrems = premiums.reduce((a, b) => a + b, 0);
            const ratio = totPrems > 0 ? ((totClaims / totPrems) * 100).toFixed(1) : 0;

            document.getElementById('kpiRatio').innerText = ratio + "%";
            document.getElementById('kpiClaims').innerText = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(totClaims);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Sinistri (Pag+Ris)',
                            data: claims,
                            backgroundColor: '#ef4444',
                            order: 1
                        },
                        {
                            label: 'Premio Imponibile',
                            data: premiums,
                            type: 'line',
                            borderColor: '#16a34a',
                            borderWidth: 3,
                            tension: 0.3,
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
    </script>
</body>

</html>