{% extends "base.html" %}

{% block title %}Report Analisi #{{ analysis.id }}{% endblock %}

{% block content %}
<!-- Use a dirty hack to break out of container for full width if desired, or stay in container -->
<!-- Breaking out of container for full layout -->
</div> <!-- Close main container -->
<div class="report-container">
    <div class="sidebar">
        <div style="margin-bottom: 30px;">
            <a href="/dashboard" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">&larr; Torna alla
                Dashboard</a>
            <a href="/upload" class="btn btn-primary" style="width: 100%;">+ Nuova Analisi</a>
        </div>

        <div style="margin-bottom: 30px;">
            <h4 style="margin-bottom: 10px;">Metadata</h4>
            <div style="font-size: 0.9em; color: var(--text-light);">
                <p><strong>File:</strong> {{ analysis.document.original_filename }}</p>
                <p><strong>Data:</strong> {{ analysis.created_at.strftime('%d/%m/%Y') }}</p>
                <p><strong>Modello:</strong> {{ analysis.llm_model }}</p>
                <p><strong>Stato:</strong> {{ analysis.status.value }}</p>
            </div>
        </div>

        <div>
            <h4 style="margin-bottom: 10px;">Download</h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <a href="/report/{{ analysis.id }}/download?format=html" target="_blank" class="btn btn-secondary">ðŸ“¥
                    HTML Completo</a>
                <a href="/report/{{ analysis.id }}/download?format=pdf" target="_blank" class="btn btn-secondary">ðŸ“¥
                    PDF</a>
                <a href="/report/{{ analysis.id }}/download?format=html_masked" target="_blank"
                    class="btn btn-secondary">ðŸ“¥ HTML Anonimizzato</a>
            </div>
        </div>
    </div>

    <div class="report-viewer">
        {% if analysis.status.value == 'completed' %}
        <iframe src="/report/{{ analysis.id }}/content" class="report-frame"></iframe>
        {% elif analysis.status.value == 'analyzing' %}
        <div style="text-align: center; padding: 50px;">
            <h2>In fase di analisi...</h2>
            <p>Attendere prego. L'analisi potrebbe richiedere qualche minuto.</p>
            <script>
                async function pollStatus() {
                    try {
                        // For MVP, just reload page if still valid 
                        // But let's check properly via an API if we had one.
                        // Since we rely on server-side rendering, reloading is fine but maybe slow?
                        // Let's stick to reload for now but increase frequency slightly if user accepts.
                        // Actually, let's implement the user's suggestion partially: API check would certainly be better but requires new route.
                        // Let's keep it simple: reload.
                        window.location.reload();
                    } catch (e) {
                        console.error("Polling error", e);
                    }
                }
                setTimeout(pollStatus, 3000);
            </script>
        </div>
        {% elif analysis.status.value == 'error' %}
        <div style="padding: 50px; color: var(--danger);">
            <h2>Errore nell'analisi</h2>
            <p>{{ analysis.error_message }}</p>
        </div>
        {% endif %}
    </div>
</div>
<div> <!-- Re-open generic div to match base closing -->
    {% endblock %}